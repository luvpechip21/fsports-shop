<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S·∫£n ph·∫©m Air Force</title>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Be Vietnam Pro', sans-serif; margin:0; }

.sticky-footer {
position: fixed; bottom: 0; left: 0; width: 100%; background: #fff;
display: flex; align-items: center; border-top: 1px solid #ddd;
z-index: 9999; padding: 8px;
}
.footer-icon {
width: 60px; text-align: center; font-size: 12px; color: #000; text-decoration: none;
}
.footer-icon img { width: 22px; height: 22px; margin-bottom: 4px; }
.footer-btn {
flex: 1; margin-left: 12px; height: 48px; background: linear-gradient(90deg, #FF512F, #FF7B2F);
color: #fff; font-weight: 700; font-size: 18px; border: none; cursor: pointer;
border-radius: 10px; transition: transform 0.2s ease, opacity 0.2s ease;
}
.footer-btn:hover { transform: scale(1.03); opacity: 0.95; }

.overlay {
position: fixed; top: 0; left: 0; width: 100%; height: 100%;
background: rgba(0,0,0,0.5); display: none; z-index: 9998;
}
#slideForm {
position: fixed; bottom: -100%; left: 0; width: 100%; background: #fff;
transition: bottom 0.4s ease; padding: 16px; z-index: 10000;
max-height: 90vh; overflow-y: auto; border-radius: 12px 12px 0 0;
}
#closeBtn {
position: absolute; top: 12px; right: 16px; background: none; border: none;
font-size: 28px; font-weight: bold; color: #333; cursor: pointer;
}
.price-box { text-align: center; margin-bottom: 12px; }
.price-old { text-decoration: line-through; color: #888; margin-right: 6px; font-size: 14px; }
.price-new { font-size: 22px; font-weight: bold; color: #FF512F; }

.gift-box {
text-align: center; background: #fff7f3; padding: 10px;
border-radius: 10px; margin-bottom: 12px;
}
.gift-box h4 { color: #FF512F; font-size: 15px; margin-bottom: 8px; }
.gift-grid {
display: grid; grid-template-columns: repeat(2, 1fr);
gap: 6px; font-size: 14px; color: #444;
}

.variant-title { font-weight: bold; margin-top: 10px; }
.variant-row {
display: flex; gap: 10px; align-items: center;
border: 1px solid #eee; padding: 10px; margin: 6px 0; border-radius: 8px;
}
.variant-row img {
width: 60px; height: 60px; object-fit: cover; border-radius: 6px;
}
.variant-info { flex: 1; font-size: 14px; }
.quantity-box {
display: flex; gap: 6px; align-items: center;
}
.quantity-box button {
width: 28px; height: 28px; font-weight: bold;
border: 1px solid #ccc; background: #f2f2f2; border-radius: 6px;
}
.quantity-box input {
width: 36px; text-align: center; border: 1px solid #ccc; border-radius: 6px;
padding: 4px; font-size: 14px;
}

.form-input input, .form-input textarea {
width: 100%; padding: 10px; margin-bottom: 10px;
border: 1px solid #ccc; border-radius: 6px; font-size: 14px;
}

.submit-btn {
width: 100%; padding: 12px; background: #FF512F;
color: white; font-weight: bold; border: none; border-radius: 10px;
font-size: 16px; transition: transform 0.2s ease, opacity 0.2s ease;
}
.submit-btn:hover { transform: scale(1.03); opacity: 0.95; }

#confirmPopup {
position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
background: white; padding: 24px; border-radius: 16px;
box-shadow: 0 6px 20px rgba(0,0,0,0.25); display: none;
text-align: center; z-index: 10001; width: 90%; max-width: 360px;
}
#confirmPopup.show { display: block; }
#confirmPopup .title {
font-size: 20px; font-weight: bold; margin-bottom: 12px; color: #FF512F;
}
#confirmPopup .sub {
font-size: 15px; line-height: 1.4; color: #333; margin-bottom: 10px;
}
#confirmPopup .ok {
font-size: 14px; font-weight: bold; color: #000;
}
#closeThanksBtn {
position: absolute; top: 8px; right: 12px; background: none; border: none;
font-size: 20px; color: #555; cursor: pointer;
}
</style>

<!-- Facebook Pixel: PH·∫¶N 2 s·∫Ω ti·∫øp t·ª•c t·∫°i ƒë√¢y -->
</head>
<body>

<!-- ‚úÖ Sticky Footer -->
<div class="sticky-footer">
<a class="footer-icon" href="tel:0947420361">
<img src="https://img.icons8.com/ios-filled/24/000000/phone.png" alt=""><br>G·ªçi
</a>
<a class="footer-icon" href="https://m.me/Lifestyle.Fsport">
<img src="https://img.icons8.com/ios-filled/24/000000/facebook-messenger.png" alt=""><br>Chat
</a>
<button id="btn-atc" class="footer-btn">MUA NGAY</button>
</div>

<!-- ‚úÖ Overlay + Form -->
<div id="overlay" class="overlay"></div>

<div id="slideForm">
<button id="closeBtn" onclick="toggleForm()">√ó</button>

<div class="price-box">
<span class="price-old" id="priceOld">‚Ç´3.100.000</span>
<span class="price-new" id="totalPrice">‚Ç´1.860.000</span>
</div>

<div class="gift-box">
<h4>üéÅ QU√Ä T·∫∂NG K√àM</h4>
<div class="gift-grid">
<span>‚úî T√∫i b·∫£o v·ªá v·ª£t</span>
<span>‚úî Qu·∫•n c√°n v·ª£t x·ªãn</span>
<span>‚úî B√≥ng thi ƒë·∫•u</span>
<span>‚úî D√°n vi·ªÅn</span>
<span>‚úî X·ªãt v·ªá sinh m·∫∑t v·ª£t</span>
</div>
</div>

<div class="variant-title">Ch·ªçn s·∫£n ph·∫©m v√† s·ªë l∆∞·ª£ng</div>
<div id="variantArea"></div>

<div class="form-input">
<input type="text" id="fullname" placeholder="H·ªç v√† t√™n">
<input type="tel" id="phone" placeholder="S·ªë ƒëi·ªán tho·∫°i">
<textarea id="address" placeholder="ƒê·ªãa ch·ªâ nh·∫≠n h√†ng"></textarea>
</div>

<button class="submit-btn" id="submitBtn">ƒê·∫∂T H√ÄNG NGAY</button>
</div>

<!-- ‚úÖ Popup c·∫£m ∆°n -->
<div id="confirmPopup">
<button id="closeThanksBtn">√ó</button>
<div class="title">üéâ C·∫¢M ∆†N B·∫†N!</div>
<div class="sub">ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n.<br>Ch√∫ng t√¥i s·∫Ω giao h√†ng s·ªõm nh·∫•t!</div>
<div class="ok">Hotline: 094.7420.361</div>
</div>

<!-- ‚úÖ SCRIPT -->
<script>
// =======================
// PIXEL INIT
// =======================
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){
n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;
s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}
(window, document,'script','https://connect.facebook.net/en_US/fbevents.js');

fbq('init', '2551563688514905'); // Pixel ch√≠nh
fbq('init', '1738204417066160', {}, {agent:'plmulti'}); // Pixel ph·ª•
fbq('track', 'PageView');

// ViewContent sau 4s (n·∫øu tab ƒëang active)
setTimeout(() => {
if (!document.hidden) {
const data = { content_name: 'Trang s·∫£n ph·∫©m Air Force', content_type: 'product_group' };
fbq('track', 'ViewContent', data);
fbq('trackSingle', '1738204417066160', 'ViewContent', data);
}
}, 4000);

// =======================
// DATA
// =======================
const variantList = [
{ T√™n: "Air Force 3K", Gi√°: 1300000, Gi√°G·ªëc: 2200000, ·∫¢nh: "https://i.postimg.cc/FHTJSW3h/Tuns-sports-template2.jpg" },
{ T√™n: "Air Force T700", Gi√°: 1200000, Gi√°G·ªëc: 2100000, ·∫¢nh: "https://i.postimg.cc/Mp6Qv2cs/Tuns-sports-template1.jpg" }
];

// =======================
// STATE & HELPERS
// =======================
let _hasFiredATC = false;
let _lastATCEventId = null;

function genEventId(prefix='evt') {
// ƒë·ªß unique cho m·ª•c ƒë√≠ch ƒë·ªëi chi·∫øu: time + random
return `${prefix}_${Date.now()}_${Math.random().toString(36).slice(2, 10)}`;
}

function formatPrice(v){ return (v||0).toLocaleString("vi-VN")+"‚Ç´"; }

function getCartSnapshot() {
const items = [];
let total = 0, oldTotal = 0, totalQty = 0;
variantList.forEach((v, i) => {
const raw = document.getElementById(`qty${i}`)?.value;
const qty = Math.max(0, parseInt(raw || "0"));
if (qty > 0) {
items.push({ id: `SP-${i+1}`, name: v.T√™n, quantity: qty, item_price: v.Gi√° });
total += qty * v.Gi√°;
oldTotal += qty * v.Gi√°G·ªëc;
totalQty += qty;
}
});
return { items, total, oldTotal, totalQty };
}

// B·∫Øn ATC ƒë√∫ng chu·∫©n: ch·ªâ khi user ƒë√£ ch·ªçn >=1 sp v√† CH·ªà L·∫¶N ƒê·∫¶U
function maybeFireATC() {
if (_hasFiredATC) return;
const { items, total, totalQty } = getCartSnapshot();
if (totalQty > 0) {
_hasFiredATC = true;
_lastATCEventId = genEventId('atc');

const pixelData = {
value: total,
currency: 'VND',
contents: items.map(it => ({ id: it.id, quantity: it.quantity, item_price: it.item_price })),
content_type: 'product',
event_id: _lastATCEventId
};
fbq('track', 'AddToCart', pixelData);
fbq('trackSingle', '1738204417066160', 'AddToCart', pixelData);
// console.log('ATC fired with event_id:', _lastATCEventId);
}
}

// =======================
// UI HANDLERS
// =======================
function toggleForm(){
const form = document.getElementById("slideForm");
const overlay = document.getElementById("overlay");
const footer = document.querySelector(".sticky-footer");
const isOpen = form.style.bottom === "0px";
form.style.bottom = isOpen ? "-100%" : "0px";
overlay.style.display = isOpen ? "none" : "block";
footer.style.display = isOpen ? "flex" : "none";
// Khi m·ªü form l·∫ßn ƒë·∫ßu, reset hi·ªÉn th·ªã gi√° = 0 cho ƒë√∫ng
if (!isOpen && document.getElementById("totalPrice")) {
updatePrice(); // ƒë·∫£m b·∫£o ƒë·ªìng b·ªô s·ªë hi·ªÉn th·ªã
}
}

document.getElementById("overlay").addEventListener("click", toggleForm);
document.getElementById("btn-atc").addEventListener("click", () => {
toggleForm();
renderVariants(); // m·ªü form r·ªìi m·ªõi render bi·∫øn th·ªÉ
// KH√îNG b·∫Øn ATC ·ªü ƒë√¢y n·ªØa (ƒë·ª£i user ch·ªçn s·ªë l∆∞·ª£ng)
});

// ESC ƒë·ªÉ ƒë√≥ng form
document.addEventListener('keydown', (e) => {
if (e.key === 'Escape') {
const form = document.getElementById("slideForm");
if (form.style.bottom === "0px") toggleForm();
}
});

function renderVariants(){
const area = document.getElementById("variantArea");
area.innerHTML = '';
variantList.forEach((v, i) => {
const row = document.createElement("div");
row.className = "variant-row";
row.innerHTML = `
<img src="${v.·∫¢nh}" alt="">
<div class="variant-info">${v.T√™n}<br><small>${formatPrice(v.Gi√°)}</small></div>
<div class="quantity-box">
<button type="button" onclick="changeQty(${i}, -1)">-</button>
<input type="number" id="qty${i}" value="0" min="0" inputmode="numeric">
<button type="button" onclick="changeQty(${i}, 1)">+</button>
</div>
`;
area.appendChild(row);
});

// L·∫Øng nghe nh·∫≠p tay ƒë·ªÉ v·∫´n t√≠nh ti·ªÅn + ki·ªÉm ATC
variantList.forEach((_, i) => {
const ip = document.getElementById(`qty${i}`);
ip.addEventListener('input', () => { updatePrice(); maybeFireATC(); });
ip.addEventListener('change', () => { updatePrice(); maybeFireATC(); });
});

// Set gi√° ban ƒë·∫ßu = 0 (ch∆∞a ch·ªçn)
document.getElementById("totalPrice").innerText = formatPrice(0);
document.getElementById("priceOld").innerText = formatPrice(0);
}

window.changeQty = function(i, delta){
const input = document.getElementById(`qty${i}`);
const next = Math.max(0, (parseInt(input.value || "0") + delta));
input.value = next;
updatePrice();
maybeFireATC(); // ch·ªâ ATC l·∫ßn ƒë·∫ßu khi t·ª´ 0 -> >0
}

function updatePrice(){
const { total, oldTotal } = getCartSnapshot();
document.getElementById("totalPrice").innerText = formatPrice(total);
document.getElementById("priceOld").innerText = formatPrice(oldTotal);
}

// =======================
// SUBMIT ORDER
// =======================
const submitBtn = document.getElementById("submitBtn");
submitBtn.addEventListener("click", async () => {
const fullname = document.getElementById("fullname").value.trim();
const phone = document.getElementById("phone").value.trim();
const address = document.getElementById("address").value.trim();

if (!fullname || !phone || !address) {
alert("‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
return;
}

const { items, total, totalQty } = getCartSnapshot();
if (totalQty === 0) {
alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 s·∫£n ph·∫©m!");
return;
}

// Sinh purchase_event_id ngay tr∆∞·ªõc khi g·ª≠i
const purchaseEventId = genEventId('purchase');

const payload = {
name: fullname,
phone: phone,
address: address,
variant: items.map(it => `${it.name} x ${it.quantity}`).join(", "),
amount: formatPrice(total), // d√πng cho email
total_raw: total, // ƒë·ªÉ ghi Sheet/sum
purchase_event_id: purchaseEventId,
atc_event_id: _lastATCEventId || null
};

// Ch·ªëng double submit
submitBtn.disabled = true;
submitBtn.textContent = "ƒêang g·ª≠i...";

try {
const res = await fetch("https://hook.us2.make.com/7vq13lzphuycaovw5q7e3x6ah3qjpcwo", {
method: "POST",
headers: { "Content-Type": "application/json" },
body: JSON.stringify(payload)
});

if (!res.ok) {
throw new Error(`Make.com HTTP ${res.status}`);
}

// G·ª≠i Purchase (ch·ªâ khi Make.com tr·∫£ v·ªÅ th√†nh c√¥ng)
const pixelData = {
value: total,
currency: 'VND',
contents: items.map(it => ({ id: it.id, quantity: it.quantity, item_price: it.item_price })),
content_type: 'product',
event_id: purchaseEventId
};
fbq('track', 'Purchase', pixelData);
fbq('trackSingle', '1738204417066160', 'Purchase', pixelData);

toggleForm();
const popup = document.getElementById("confirmPopup");
popup.classList.add("show");
setTimeout(() => popup.classList.remove("show"), 6000);

} catch (err) {
console.error("‚ùå G·ª≠i ƒë∆°n h√†ng l·ªói:", err);
alert("‚ùå C√≥ l·ªói khi g·ª≠i ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i sau.");
} finally {
submitBtn.disabled = false;
submitBtn.textContent = "ƒê·∫∂T H√ÄNG NGAY";
}
});

// ƒê√≥ng popup c·∫£m ∆°n
document.getElementById("closeThanksBtn").addEventListener("click", () => {
document.getElementById("confirmPopup").classList.remove("show");
});
</script>

</body>
</html>